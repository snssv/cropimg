(function(){var rsplit=function(string,regex){var result=regex.exec(string),retArr=new Array(),first_idx,last_idx,first_bit;while(result!=null){first_idx=result.index;last_idx=regex.lastIndex;if((first_idx)!=0){first_bit=string.substring(0,first_idx);retArr.push(string.substring(0,first_idx));string=string.slice(first_idx)}retArr.push(result[0]);string=string.slice(result[0].length);result=regex.exec(string)}if(!string==""){retArr.push(string)}return retArr},chop=function(string){return string.substr(0,string.length-1)},extend=function(d,s){for(var n in s){if(s.hasOwnProperty(n)){d[n]=s[n]}}};EJS=function(options){options=typeof options=="string"?{view:options}:options;this.set_options(options);if(options.precompiled){this.template={};this.template.process=options.precompiled;EJS.update(this.name,this);return }if(options.element){if(typeof options.element=="string"){var name=options.element;options.element=document.getElementById(options.element);if(options.element==null){throw name+"does not exist!"}}if(options.element.value){this.text=options.element.value}else{this.text=options.element.innerHTML}this.name=options.element.id;this.type="["}else{if(options.url){options.url=EJS.endExt(options.url,this.extMatch);this.name=this.name?this.name:options.url;var url=options.url;var template=EJS.get(this.name,this.cache);if(template){return template}if(template==EJS.INVALID_PATH){return null}try{this.text=EJS.request(url+(this.cache?"":"?"+Math.random()))}catch(e){}if(this.text==null){throw ({type:"EJS",message:"There is no template at "+url})}}}var template=new EJS.Compiler(this.text,this.type);template.compile(options,this.name);EJS.update(this.name,this);this.template=template};EJS.prototype={render:function(object,extra_helpers){object=object||{};this._extra_helpers=extra_helpers;var v=new EJS.Helpers(object,extra_helpers||{});return this.template.process.call(object,object,v)},update:function(element,options){if(typeof element=="string"){element=document.getElementById(element)}if(options==null){_template=this;return function(object){EJS.prototype.update.call(_template,element,object)}}if(typeof options=="string"){params={};params.url=options;_template=this;params.onComplete=function(request){var object=eval(request.responseText);EJS.prototype.update.call(_template,element,object)};EJS.ajax_request(params)}else{element.innerHTML=this.render(options)}},out:function(){return this.template.out},set_options:function(options){this.type=options.type||EJS.type;this.cache=options.cache!=null?options.cache:EJS.cache;this.text=options.text||null;this.name=options.name||null;this.ext=options.ext||EJS.ext;this.extMatch=new RegExp(this.ext.replace(/\./,"."))}};EJS.endExt=function(path,match){if(!path){return null}match.lastIndex=0;return path+(match.test(path)?"":this.ext)};EJS.Scanner=function(source,left,right){extend(this,{left_delimiter:left+"%",right_delimiter:"%"+right,double_left:left+"%%",double_right:"%%"+right,left_equal:left+"%=",left_comment:left+"%#"});this.SplitRegexp=left=="["?/(\[%%)|(%%\])|(\[%=)|(\[%#)|(\[%)|(%\]\n)|(%\])|(\n)/:new RegExp("("+this.double_left+")|(%%"+this.double_right+")|("+this.left_equal+")|("+this.left_comment+")|("+this.left_delimiter+")|("+this.right_delimiter+"\n)|("+this.right_delimiter+")|(\n)");this.source=source;this.stag=null;this.lines=0};EJS.Scanner.to_text=function(input){if(input==null||input===undefined){return""}if(input instanceof Date){return input.toDateString()}if(input.toString){return input.toString()}return""};EJS.Scanner.prototype={scan:function(block){scanline=this.scanline;regex=this.SplitRegexp;if(!this.source==""){var source_split=rsplit(this.source,/\n/);for(var i=0;i<source_split.length;i++){var item=source_split[i];this.scanline(item,regex,block)}}},scanline:function(line,regex,block){this.lines++;var line_split=rsplit(line,regex);for(var i=0;i<line_split.length;i++){var token=line_split[i];if(token!=null){try{block(token,this)}catch(e){throw {type:"EJS.Scanner",line:this.lines}}}}}};EJS.Buffer=function(pre_cmd,post_cmd){this.line=new Array();this.script="";this.pre_cmd=pre_cmd;this.post_cmd=post_cmd;for(var i=0;i<this.pre_cmd.length;i++){this.push(pre_cmd[i])}};EJS.Buffer.prototype={push:function(cmd){this.line.push(cmd)},cr:function(){this.script=this.script+this.line.join("; ");this.line=new Array();this.script=this.script+"\n"},close:function(){if(this.line.length>0){for(var i=0;i<this.post_cmd.length;i++){this.push(pre_cmd[i])}this.script=this.script+this.line.join("; ");line=null}}};EJS.Compiler=function(source,left){this.pre_cmd=["var ___ViewO = [];"];this.post_cmd=new Array();this.source=" ";if(source!=null){if(typeof source=="string"){source=source.replace(/\r\n/g,"\n");source=source.replace(/\r/g,"\n");this.source=source}else{if(source.innerHTML){this.source=source.innerHTML}}if(typeof this.source!="string"){this.source=""}}left=left||"<";var right=">";switch(left){case"[":right="]";break;case"<":break;default:throw left+" is not a supported deliminator";break}this.scanner=new EJS.Scanner(this.source,left,right);this.out=""};EJS.Compiler.prototype={compile:function(options,name){options=options||{};this.out="";var put_cmd="___ViewO.push(";var insert_cmd=put_cmd;var buff=new EJS.Buffer(this.pre_cmd,this.post_cmd);var content="";var clean=function(content){content=content.replace(/\\/g,"\\\\");content=content.replace(/\n/g,"\\n");content=content.replace(/"/g,'\\"');return content};this.scanner.scan(function(token,scanner){if(scanner.stag==null){switch(token){case"\n":content=content+"\n";buff.push(put_cmd+'"'+clean(content)+'");');buff.cr();content="";break;case scanner.left_delimiter:case scanner.left_equal:case scanner.left_comment:scanner.stag=token;if(content.length>0){buff.push(put_cmd+'"'+clean(content)+'")')}content="";break;case scanner.double_left:content=content+scanner.left_delimiter;break;default:content=content+token;break}}else{switch(token){case scanner.right_delimiter:switch(scanner.stag){case scanner.left_delimiter:if(content[content.length-1]=="\n"){content=chop(content);buff.push(content);buff.cr()}else{buff.push(content)}break;case scanner.left_equal:buff.push(insert_cmd+"(EJS.Scanner.to_text("+content+")))");break}scanner.stag=null;content="";break;case scanner.double_right:content=content+scanner.right_delimiter;break;default:content=content+token;break}}});if(content.length>0){buff.push(put_cmd+'"'+clean(content)+'")')}buff.close();this.out=buff.script+";";var to_be_evaled="/*"+name+"*/this.process = function(_CONTEXT,_VIEW) { try { with(_VIEW) { with (_CONTEXT) {"+this.out+" return ___ViewO.join('');}}}catch(e){e.lineNumber=null;throw e;}};";try{eval(to_be_evaled)}catch(e){if(typeof JSLINT!="undefined"){JSLINT(this.out);for(var i=0;i<JSLINT.errors.length;i++){var error=JSLINT.errors[i];if(error.reason!="Unnecessary semicolon."){error.line++;var e=new Error();e.lineNumber=error.line;e.message=error.reason;if(options.view){e.fileName=options.view}throw e}}}else{throw e}}}};EJS.config=function(options){EJS.cache=options.cache!=null?options.cache:EJS.cache;EJS.type=options.type!=null?options.type:EJS.type;EJS.ext=options.ext!=null?options.ext:EJS.ext;var templates_directory=EJS.templates_directory||{};EJS.templates_directory=templates_directory;EJS.get=function(path,cache){if(cache==false){return null}if(templates_directory[path]){return templates_directory[path]}return null};EJS.update=function(path,template){if(path==null){return }templates_directory[path]=template};EJS.INVALID_PATH=-1};EJS.config({cache:true,type:"<",ext:".ejs"});EJS.Helpers=function(data,extras){this._data=data;this._extras=extras;extend(this,extras)};EJS.Helpers.prototype={view:function(options,data,helpers){if(!helpers){helpers=this._extras}if(!data){data=this._data}return new EJS(options).render(data,helpers)},to_text:function(input,null_text){if(input==null||input===undefined){return null_text||""}if(input instanceof Date){return input.toDateString()}if(input.toString){return input.toString().replace(/\n/g,"<br />").replace(/''/g,"'")}return""}};EJS.newRequest=function(){var factories=[function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new XMLHttpRequest()},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];for(var i=0;i<factories.length;i++){try{var request=factories[i]();if(request!=null){return request}}catch(e){continue}}};EJS.request=function(path){var request=new EJS.newRequest();request.open("GET",path,false);try{request.send(null)}catch(e){return null}if(request.status==404||request.status==2||(request.status==0&&request.responseText=="")){return null}return request.responseText};EJS.ajax_request=function(params){params.method=(params.method?params.method:"GET");var request=new EJS.newRequest();request.onreadystatechange=function(){if(request.readyState==4){if(request.status==200){params.onComplete(request)}else{params.onComplete(request)}}};request.open(params.method,params.url);request.send(null)}})();EJS.Helpers.prototype.date_tag=function(C,O,A){if(!(O instanceof Date)){O=new Date()}var B=["January","February","March","April","May","June","July","August","September","October","November","December"];var G=[],D=[],P=[];var J=O.getFullYear();var H=O.getMonth();var N=O.getDate();for(var M=J-15;M<J+15;M++){G.push({value:M,text:M})}for(var E=0;E<12;E++){D.push({value:(E),text:B[E]})}for(var I=0;I<31;I++){P.push({value:(I+1),text:(I+1)})}var L=this.select_tag(C+"[year]",J,G,{id:C+"[year]"});var F=this.select_tag(C+"[month]",H,D,{id:C+"[month]"});var K=this.select_tag(C+"[day]",N,P,{id:C+"[day]"});return L+F+K};EJS.Helpers.prototype.form_tag=function(B,A){A=A||{};A.action=B;if(A.multipart==true){A.method="post";A.enctype="multipart/form-data"}return this.start_tag_for("form",A)};EJS.Helpers.prototype.form_tag_end=function(){return this.tag_end("form")};EJS.Helpers.prototype.hidden_field_tag=function(A,C,B){return this.input_field_tag(A,C,"hidden",B)};EJS.Helpers.prototype.input_field_tag=function(A,D,C,B){B=B||{};B.id=B.id||A;B.value=D||"";B.type=C||"text";B.name=A;return this.single_tag_for("input",B)};EJS.Helpers.prototype.is_current_page=function(A){return(window.location.href==A||window.location.pathname==A?true:false)};EJS.Helpers.prototype.link_to=function(B,A,C){if(!B){var B="null"}if(!C){var C={}}if(C.confirm){C.onclick=' var ret_confirm = confirm("'+C.confirm+'"); if(!ret_confirm){ return false;} ';C.confirm=null}C.href=A;return this.start_tag_for("a",C)+B+this.tag_end("a")};EJS.Helpers.prototype.submit_link_to=function(B,A,C){if(!B){var B="null"}if(!C){var C={}}C.onclick=C.onclick||"";if(C.confirm){C.onclick=' var ret_confirm = confirm("'+C.confirm+'"); if(!ret_confirm){ return false;} ';C.confirm=null}C.value=B;C.type="submit";C.onclick=C.onclick+(A?this.url_for(A):"")+"return false;";return this.start_tag_for("input",C)};EJS.Helpers.prototype.link_to_if=function(F,B,A,D,C,E){return this.link_to_unless((F==false),B,A,D,C,E)};EJS.Helpers.prototype.link_to_unless=function(E,B,A,C,D){C=C||{};if(E){if(D&&typeof D=="function"){return D(B,A,C,D)}else{return B}}else{return this.link_to(B,A,C)}};EJS.Helpers.prototype.link_to_unless_current=function(B,A,C,D){C=C||{};return this.link_to_unless(this.is_current_page(A),B,A,C,D)};EJS.Helpers.prototype.password_field_tag=function(A,C,B){return this.input_field_tag(A,C,"password",B)};EJS.Helpers.prototype.select_tag=function(D,G,H,F){F=F||{};F.id=F.id||D;F.value=G;F.name=D;var B="";B+=this.start_tag_for("select",F);for(var E=0;E<H.length;E++){var C=H[E];var A={value:C.value};if(C.value==G){A.selected="selected"}B+=this.start_tag_for("option",A)+C.text+this.tag_end("option")}B+=this.tag_end("select");return B};EJS.Helpers.prototype.single_tag_for=function(A,B){return this.tag(A,B,"/>")};EJS.Helpers.prototype.start_tag_for=function(A,B){return this.tag(A,B)};EJS.Helpers.prototype.submit_tag=function(A,B){B=B||{};B.type=B.type||"submit";B.value=A||"Submit";return this.single_tag_for("input",B)};EJS.Helpers.prototype.tag=function(C,E,D){if(!D){var D=">"}var B=" ";for(var A in E){if(E[A]!=null){var F=E[A].toString()}else{var F=""}if(A=="Class"){A="class"}if(F.indexOf("'")!=-1){B+=A+'="'+F+'" '}else{B+=A+"='"+F+"' "}}return"<"+C+B+D};EJS.Helpers.prototype.tag_end=function(A){return"</"+A+">"};EJS.Helpers.prototype.text_area_tag=function(A,C,B){B=B||{};B.id=B.id||A;B.name=B.name||A;C=C||"";if(B.size){B.cols=B.size.split("x")[0];B.rows=B.size.split("x")[1];delete B.size}B.cols=B.cols||50;B.rows=B.rows||4;return this.start_tag_for("textarea",B)+C+this.tag_end("textarea")};EJS.Helpers.prototype.text_tag=EJS.Helpers.prototype.text_area_tag;EJS.Helpers.prototype.text_field_tag=function(A,C,B){return this.input_field_tag(A,C,"text",B)};EJS.Helpers.prototype.url_for=function(A){return'window.location="'+A+'";'};EJS.Helpers.prototype.img_tag=function(B,C,A){A=A||{};A.src=B;A.alt=C;return this.single_tag_for("img",A)}

var EXIF=function(){function w(a,c){c||a.match(/^data\:([^\;]+)\;base64,/mi);for(var a=a.replace(/^data\:([^\;]+)\;base64,/gmi,""),b=atob(a),f=b.length,d=new ArrayBuffer(f),e=new Uint8Array(d),g=0;g<f;g++)e[g]=b.charCodeAt(g);return d}function x(a,c){var b=new XMLHttpRequest;b.open("GET",a,!0);b.responseType="blob";b.onload=function(){(200==this.status||0===this.status)&&c(this.response)};b.send()}function y(a,c){function b(b){var e=r(b),d;a:if(d=new DataView(b),h&&console.log("Got file of length "+b.byteLength),255!=d.getUint8(0)||216!=d.getUint8(1))h&&console.log("Not a valid JPEG"),d=!1;else{for(var f=2,j=b.byteLength;f<j;){if(56===d.getUint8(f)&&66===d.getUint8(f+1)&&73===d.getUint8(f+2)&&77===d.getUint8(f+3)&&4===d.getUint8(f+4)&&4===d.getUint8(f+5)){var i=d.getUint8(f+7);0!==i%2&&(i+=1);0===i&&(i=4);j=f+8+i;f=d.getUint16(f+6+i);d=j;for(var b=new DataView(b),j={},o=void 0,k=void 0,k=o=void 0,i=d;i<d+f;)28===b.getUint8(i)&&2===b.getUint8(i+1)&&(k=b.getUint8(i+2),k in s&&(o=b.getInt16(i+3),k=s[k],o=m(b,i+5,o),j.hasOwnProperty(k)?j[k]instanceof Array?j[k].push(o):j[k]=[j[k],o]:j[k]=o)),i++;d=j;break a}f++}d=void 0}a.exifdata=e||{};a.iptcdata=d||{};c&&c.call(a)}if(a instanceof Image||a instanceof HTMLImageElement)if(/^data\:/i.test(a.src)){var f=w(a.src);b(f)}else if(/^blob\:/i.test(a.src)){var d=new FileReader;d.onload=function(a){b(a.target.result)};x(a.src,function(a){d.readAsArrayBuffer(a)})}else{var e=new XMLHttpRequest;e.onload=function(){if("200"==e.status)b(e.response);else throw"Could not load image";e=null};e.open("GET",a.src,!0);e.responseType="arraybuffer";e.send(null)}else if(window.FileReader&&(a instanceof window.Blob||a instanceof window.File))d=new FileReader,d.onload=function(a){h&&console.log("Got file of length "+a.target.result.byteLength);b(a.target.result)},d.readAsArrayBuffer(a)}function r(a){var c=new DataView(a);h&&console.log("Got file of length "+a.byteLength);if(255!=c.getUint8(0)||216!=c.getUint8(1))return h&&console.log("Not a valid JPEG"),!1;for(var b=2,a=a.byteLength,f;b<a;){if(255!=c.getUint8(b))return h&&console.log("Not a valid marker at offset "+b+", found: "+c.getUint8(b)),!1;f=c.getUint8(b+1);h&&console.log(f);if(225==f)return h&&console.log("Found 0xFFE1 marker"),z(c,b+4,c.getUint16(b+2)-2);b+=2+c.getUint16(b+2)}}function q(a,c,b,f,d){var e=a.getUint16(b,!d),g={},p,l,m;for(m=0;m<e;m++)p=b+12*m+2,l=f[a.getUint16(p,!d)],!l&&h&&console.log("Unknown tag: "+a.getUint16(p,!d)),g[l]=A(a,p,c,b,d);return g}function A(a,c,b,f,d){var e=a.getUint16(c+2,!d),f=a.getUint32(c+4,!d),b=a.getUint32(c+8,!d)+b,g,h;switch(e){case 1:case 7:if(1==f)return a.getUint8(c+8,!d);b=4<f?b:c+8;c=[];for(e=0;e<f;e++)c[e]=a.getUint8(b+e);return c;case 2:return m(a,4<f?b:c+8,f-1);case 3:if(1==f)return a.getUint16(c+8,!d);b=2<f?b:c+8;c=[];for(e=0;e<f;e++)c[e]=a.getUint16(b+2*e,!d);return c;case 4:if(1==f)return a.getUint32(c+8,!d);c=[];for(e=0;e<f;e++)c[e]=a.getUint32(b+4*e,!d);return c;case 5:if(1==f)return g=a.getUint32(b,!d),h=a.getUint32(b+4,!d),a=new Number(g/h),a.numerator=g,a.denominator=h,a;c=[];for(e=0;e<f;e++)g=a.getUint32(b+8*e,!d),h=a.getUint32(b+4+8*e,!d),c[e]=new Number(g/h),c[e].numerator=g,c[e].denominator=h;return c;case 9:if(1==f)return a.getInt32(c+8,!d);c=[];for(e=0;e<f;e++)c[e]=a.getInt32(b+4*e,!d);return c;case 10:if(1==f)return a.getInt32(b,!d)/a.getInt32(b+4,!d);c=[];for(e=0;e<f;e++)c[e]=a.getInt32(b+8*e,!d)/a.getInt32(b+4+8*e,!d);return c}}function m(a,c,b){var f="";for(n=c;n<c+b;n++)f+=String.fromCharCode(a.getUint8(n));return f}function z(a,c){if("Exif"!=m(a,c,4))return h&&console.log("Not valid EXIF data! "+m(a,c,4)),!1;var b,f,d,e,g=c+6;if(18761==a.getUint16(g))b=!1;else if(19789==a.getUint16(g))b=!0;else return h&&console.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)"),!1;if(42!=a.getUint16(g+2,!b))return h&&console.log("Not valid TIFF data! (no 0x002A)"),!1;f=a.getUint32(g+4,!b);if(8>f)return h&&console.log("Not valid TIFF data! (First offset less than 8)",a.getUint32(g+4,!b)),!1;f=q(a,g,g+f,t,b);if(f.ExifIFDPointer)for(d in e=q(a,g,g+f.ExifIFDPointer,u,b),e){switch(d){case"LightSource":case"Flash":case"MeteringMode":case"ExposureProgram":case"SensingMethod":case"SceneCaptureType":case"SceneType":case"CustomRendered":case"WhiteBalance":case"GainControl":case"Contrast":case"Saturation":case"Sharpness":case"SubjectDistanceRange":case"FileSource":e[d]=l[d][e[d]];break;case"ExifVersion":case"FlashpixVersion":e[d]=String.fromCharCode(e[d][0],e[d][1],e[d][2],e[d][3]);break;case"ComponentsConfiguration":e[d]=l.Components[e[d][0]]+l.Components[e[d][1]]+l.Components[e[d][2]]+l.Components[e[d][3]]}f[d]=e[d]}if(f.GPSInfoIFDPointer)for(d in b=q(a,g,g+f.GPSInfoIFDPointer,v,b),b){switch(d){case"GPSVersionID":b[d]=b[d][0]+"."+b[d][1]+"."+b[d][2]+"."+b[d][3]}f[d]=b[d]}return f}var h=!1,u={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"},t={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},v={"0":"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},l={ExposureProgram:{"0":"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{"0":"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{"0":"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{"0":"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{"0":"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{"0":"Normal process",1:"Custom process"},WhiteBalance:{"0":"Auto white balance",1:"Manual white balance"},GainControl:{"0":"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{"0":"Normal",1:"Soft",2:"Hard"},Saturation:{"0":"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{"0":"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{"0":"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{"0":"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}},s={120:"caption",110:"credit",25:"keywords",55:"dateCreated",80:"byline",85:"bylineTitle",122:"captionWriter",105:"headline",116:"copyright",15:"category"};return{readFromBinaryFile:function(a){return r(a)},pretty:function(a){if(!a.exifdata)return"";var c,a=a.exifdata,b="";for(c in a)a.hasOwnProperty(c)&&(b="object"==typeof a[c]?a[c]instanceof Number?b+(c+" : "+a[c]+" ["+a[c].numerator+"/"+a[c].denominator+"]\r\n"):b+(c+" : ["+a[c].length+" values]\r\n"):b+(c+" : "+a[c]+"\r\n"));return b},getTag:function(a,c){if(a.exifdata)return a.exifdata[c]},getAllTags:function(a){if(!a.exifdata)return{};var c,a=a.exifdata,b={};for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},getData:function(a,c){if((a instanceof Image||a instanceof HTMLImageElement)&&!a.complete)return!1;a.exifdata?c&&c.call(a):y(a,c);return!0},Tags:u,TiffTags:t,GPSTags:v,StringValues:l}}();

function ImgCut(p){var A={cutWidth:150,cutHeight:200,containerWidth:800,containerHeight:600,imageShowWidth:400,imageShowHeight:500,containerElement:"",showCutterInFirst:true,saveMode:"ratio"};$.extend(A,p);function f(F){return;var E=$("<div></div>");E.text(F);$("#debug").append(E)}function j(){$("#debug").empty()}var t=this;var b=$(A.containerElement);var o=b.find('[ui="image-editor-panel"]');var s=b.find('[ui="background-layout"]')[0];var w=b.find("[ui='cutter-layout']")[0];var c=b.find("[ui='operation-layout']")[0];var n=w.getContext("2d");var u=s.getContext("2d");var D="";var m=new Image();var x=document.createElement("canvas");var i=x.getContext("2d");var h=document.createElement("canvas");var a=h.getContext("2d");var C=document.createElement("canvas");var l=C.getContext("2d");var e=document.createElement("canvas");var q=e.getContext("2d");var g={location:{x:0,y:0},size:{w:0,h:0},ratio:1};var r={angle:0,img_bg_0:null,img_bg_90:null,img_bg_180:null,img_bg_270:null,location:{x:0,y:0},size:{w:0,h:0},originSize:{w:0,h:0},zoom:1};var d={angle:0,location:{x:0,y:0},size:{w:0,h:0},originSize:{w:0,h:0},zoom:1};var z={size:{w:0,h:0}};var B={panelInfo:{absoluteTop:0,absoluteLeft:0,offsetWidth:0,offsetHeight:0},isInDrag:false,beginPoint:{x:0,y:0},point1:{x:0,y:0},point2:{x:0,y:0},isInCut:false};var v={panelSize:{w:0,h:0},hasImage:false,imageFile:"",minScale:0,handlingMovement:false,timeSepOnHandling:25,movementInterval:null};var y={browser:{versions:function(){var E=navigator.userAgent,F=navigator.appVersion;return{trident:E.indexOf("Trident")>-1,presto:E.indexOf("Presto")>-1,webKit:E.indexOf("AppleWebKit")>-1,gecko:E.indexOf("Gecko")>-1&&E.indexOf("KHTML")==-1,mobile:!!E.match(/AppleWebKit.*Mobile.*/),ios:!!E.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:E.indexOf("Android")>-1||E.indexOf("Linux")>-1,iPhone:E.indexOf("iPhone")>-1,iPad:E.indexOf("iPad")>-1,webApp:E.indexOf("Safari")==-1}}(),language:(navigator.browserLanguage||navigator.language).toLowerCase()},GetAbsoluteLocationEx:function(G){if(arguments.length!=1||G==null){return null}var F=G;var I=F.offsetTop;var K=F.offsetLeft;var H=F.offsetWidth;var E=F.offsetHeight;while(F=F.offsetParent){if(F.style.position=="absolute"||F.style.position=="relative"||(F.style.overflow!="visible"&&F.style.overflow!="")){break}I+=F.offsetTop;K+=F.offsetLeft}var J={absoluteTop:I,absoluteLeft:K,offsetWidth:H,offsetHeight:E};return J},drawImageIOSFix:function(N,G,L,K,M,H,P,O,E,J){function F(U){var R=U.naturalWidth,Z=U.naturalHeight;var Q=document.createElement("canvas");Q.width=1;Q.height=Z;var aa=Q.getContext("2d");aa.drawImage(U,0,0);var T=aa.getImageData(0,0,1,Z).data;var X=0;var V=Z;var Y=Z;while(Y>X){var S=T[(Y-1)*4+3];if(S===0){V=Y}else{X=Y}Y=(V+X)>>1}var W=(Y/Z);return(W===0)?1:W}var I=F(G);N.drawImage(G,L*I,K*I,M*I,H*I,P,O,E,J)}};var k={init:function(){var E=this;v.panelSize.w=A.containerWidth;v.panelSize.h=A.containerHeight;if(y.browser.versions.ios==true){f("当前使用ios系统，将做特别bug修复。")}E.render_ui();E.init_cutter();E.initOperationLayout()},render_ui:function(){b.css({width:A.containerWidth+"px",height:A.containerHeight+"px"}).css("height","auto");o.css("height",A.containerHeight+"px");s.width=A.containerWidth;s.height=A.containerHeight;w.width=A.containerWidth;w.height=A.containerHeight;c.width=A.containerWidth;c.height=A.containerHeight},init_cutter:function(){var H=this;g.size.w=A.cutWidth;g.size.h=A.cutHeight;g.ratio=A.cutWidth/A.cutHeight;var E=v.panelSize.w/2;var I=v.panelSize.h/2;var G=E-g.size.w/2;var F=I-g.size.h/2;g.location.x=G;g.location.y=F;if(A.showCutterInFirst){H.updateCutter()}},updateCutter:function(){var E=this;E.__clear_cutter_canvas();E.__draw_mask();E.__draw_cutter()},__clear_cutter_canvas:function(){n.clearRect(0,0,w.width,w.height)},__draw_cutter:function(){n.strokeStyle="#ffffff";n.lineWidth=2;n.strokeRect(g.location.x,g.location.y,g.size.w,g.size.h);n.clearRect(g.location.x,g.location.y,g.size.w,g.size.h)},__draw_mask:function(){n.fillStyle="rgba(0, 0, 0, 0.3)";n.fillRect(0,0,w.width,w.height)},MoveCutter:function(F,E){var G=this;g.location.x=F;g.location.y=E;G.updateCutter()},MoveCutterByDelta:function(I,G){var F=this;var E=g.location.x+I;var H=g.location.y+G;E=parseInt(E);H=parseInt(H);if(E<0){E=0}if(H<0){H=0}if(E>(v.panelSize.w-g.size.w)){E=v.panelSize.w-g.size.w}if(H>(v.panelSize.h-g.size.h)){H=v.panelSize.h-g.size.h}F.MoveCutter(E,H)},init_background:function(E,G){var F=this;v.imageFile=G;F.init_bg_data(E,function(H){f("初始化背景时候更新背景图片。");F.updateBackground()})},init_bg_data:function(F,H){var E=this;function G(L,J){v.hasImage=true;r.originSize.w=parseInt(L);r.originSize.h=parseInt(J);r.angle=0;r.location.x=0;r.location.y=0;r.zoom=1;r.size.w=r.originSize.w;r.size.h=r.originSize.h;if(r.originSize.w>v.panelSize.w||r.originSize.h>v.panelSize.h){var I=Math.max(r.originSize.w/v.panelSize.w,r.originSize.h/v.panelSize.h);var K=parseInt(r.originSize.w/I);var M=parseInt(r.originSize.h/I);r.zoom=1/I;r.size.w=K;r.size.h=M}r.location.x=parseInt((v.panelSize.w-r.size.w)/2);r.location.y=parseInt((v.panelSize.h-r.size.h)/2);d.angle=r.angle;d.location.x=r.location.x;d.location.y=r.location.y;d.size.w=r.size.w;d.size.h=r.size.h;d.originSize.w=r.originSize.w;d.originSize.h=r.originSize.h;d.zoom=r.zoom;h.width=r.originSize.h;h.height=r.originSize.w;C.width=r.originSize.w;C.height=r.originSize.h;e.width=r.originSize.h;e.height=r.originSize.w;a.clearRect(0,0,h.width,h.height);h.width=r.originSize.h;h.height=r.originSize.w;a.save();a.rotate(Math.PI/2);a.drawImage(x,0,0-r.originSize.h);a.restore();l.clearRect(0,0,C.width,C.height);C.width=r.originSize.w;C.height=r.originSize.h;l.save();l.rotate(Math.PI);l.drawImage(x,0-r.originSize.w,0-r.originSize.h);l.restore();q.clearRect(0,0,e.width,e.height);e.width=r.originSize.h;e.height=r.originSize.w;q.save();q.rotate(Math.PI*1.5);q.drawImage(x,0-r.originSize.w,0);q.restore();v.minScale=Math.max(g.size.w/d.originSize.w,g.size.h/d.originSize.h);if(H){H()}}if(y.browser.versions.ios==true){E._setOriginCanvasInIOS(F,function(J,I){G(J,I)})}else{E._setOriginCanvasInOther(F,function(J,I){G(J,I)})}},_setOriginCanvasInIOS:function(G,H){var E=new Image();var F=new MegaPixImage(v.imageFile);E.onload=function(){var L=E.naturalWidth,R=E.naturalHeight;var K=L-L%100;var N=R-R%100;if(K<=0){K=100}if(N<=0){N=100}if(K>1400){K=1400}if(N>1400){N=1400}f("ios: 当前最大尺寸获取为[满一百]"+K+"：x "+N+" 真实尺寸为："+L+" x  "+R);var I=L;var O=R;if(L>K||R>N){var M=Math.max(L/K,R/N);var J=L/M;var Q=R/M;J=parseInt(J);Q=parseInt(Q);I=J;O=Q}f("ios: 等比例缩放尺寸为："+I+" x  "+O);E.onload=function(){};var P={maxWidth:K,maxHeight:N};F.render(x,P,function(){if(H){H(I,O,x)}})};E.src=G},_setOriginCanvasInOther:function(F,G){D=F;var E=new Image();E.onload=function(){var I=E.naturalWidth;var H=E.naturalHeight;i.clearRect(0,0,x.width,x.height);x.width=I;x.height=H;i.drawImage(E,0,0);if(G){G(I,H,x)}};E.src=F},clear_background:function(){u.clearRect(0,0,s.width,s.height)},updateBackground:function(){var E=this;E.clear_background();var I={get_x:0,get_y:0,get_w:0,get_h:0,put_x:0,put_y:0,put_w:0,put_h:0};var H="";if(d.location.x<0){I.get_x=Math.abs(d.location.x)}if(d.location.y<0){I.get_y=Math.abs(d.location.y)}I.get_w=d.size.w>v.panelSize.w?v.panelSize.w:d.size.w;I.get_h=d.size.h>v.panelSize.h?v.panelSize.h:d.size.h;if(I.get_x+d.size.w>v.panelSize.w){I.get_w=v.panelSize.w-I.get_x}if(I.get_y+d.size.h>v.panelSize.h){I.get_h=v.panelSize.h-I.get_y}if(d.location.x>0){I.put_x=d.location.x}if(d.location.y>0){I.put_y=d.location.y}I.put_w=I.get_w;I.put_h=I.get_h;I.get_x=parseInt(I.get_x/d.zoom);I.get_y=parseInt(I.get_y/d.zoom);I.get_w=parseInt(I.get_w/d.zoom);I.get_h=parseInt(I.get_h/d.zoom);if(I.get_w>d.originSize.w){I.get_w=d.originSize.w}if(I.get_h>d.originSize.h){I.get_h=d.originSize.h}var G="";var F="";if(d.angle==0||d.angle==360){G=i;F=x}else{if(d.angle==90){G=a;F=h}else{if(d.angle==180){G=l;F=C}else{if(d.angle==270){G=q;F=e}}}}window.now_context=G;window.context_bg=u;window.cut_info=I;u.drawImage(F,0,0,d.originSize.w,d.originSize.h,d.location.x,d.location.y,d.size.w,d.size.h);return;H=G.getImageData(I.get_x,I.get_y,I.get_w,I.get_h);u.save();u.scale(d.zoom,d.zoom);u.putImageData(H,0,0,I.put_x,I.put_y,I.put_w,I.put_h);u.restore()},MoveBackground:function(F,E){d.location.x=F;d.location.y=E;var G=this;G.updateBackground()},MoveBackgroundByDelta:function(H,G){var I=this;var K=d.location.x+H;var J=d.location.y+G;K=parseInt(K);J=parseInt(J);var M=0;var F=0;if(d.size.w<=g.size.w){M=0;F=v.panelSize.w-d.size.w}else{M=g.size.w-d.size.w;F=v.panelSize.w-g.size.w}var L=0;var E=0;if(d.size.h<=g.size.h){L=0;E=v.panelSize.h-d.size.h}else{L=g.size.h-d.size.h;E=v.panelSize.h-g.size.h}if(K<M){K=M}else{if(K>F){K=F}}if(J<L){J=L}else{if(J>E){J=E}}f("当前需要移动的x 和 y是："+K+" x "+J);I.MoveBackground(K,J)},ScaleBackground:function(G){var F=0;var E=0;F=d.location.x+d.size.w/2;E=d.location.y+d.size.h/2;d.zoom=G;d.size.w=parseInt(d.originSize.w*G);d.size.h=parseInt(d.originSize.h*G);var J=parseInt(F-(d.size.w)/2);var I=parseInt(E-(d.size.h)/2);d.location.x=J;d.location.y=I;var H=this;H.updateBackground()},RotateImage:function(J){var H=this;if(J!=0&&J!=90&&J!=180&&J!=270&&J!=360){return}var I=d.angle;var F=0;var E=0;F=d.location.x+d.size.w/2;E=d.location.y+d.size.h/2;if(J==0||J==360){d.angle=0;d.originSize.w=r.originSize.w;d.originSize.h=r.originSize.h}else{if(J==90){d.angle=90;d.originSize.w=r.originSize.h;d.originSize.h=r.originSize.w}else{if(J==180){d.angle=180;d.originSize.w=r.originSize.w;d.originSize.h=r.originSize.h}else{if(J==270){d.angle=270;d.originSize.w=r.originSize.h;d.originSize.h=r.originSize.w}}}}d.size.w=parseInt(d.originSize.w*d.zoom);d.size.h=parseInt(d.originSize.h*d.zoom);d.location.x=parseInt(F-(d.size.w)/2);d.location.y=parseInt(E-(d.size.h)/2);d.angle=J;var G=this;G.updateBackground()},initOperationLayout:function(){var E=this;B.panelInfo=y.GetAbsoluteLocationEx(c);if(y.browser.versions.mobile==true||y.browser.versions.mobile==true||y.browser.versions.android||y.browser.versions.iPhone){E._init_mobile_operations()}else{E._init_pc_operations()}},_init_pc_operations:function(){var E=this;$(c).mousedown(function(H){if(v.hasImage==false){return}B.isInDrag=true;B.panelInfo=y.GetAbsoluteLocationEx(c);if(B.panelInfo.absoluteLeft==0&&B.panelInfo.absoluteTop==0&&B.panelInfo.offsetHeight==0&&B.panelInfo.offsetWidth==0){}if(!H){H=window.event;c.onselectstart=function(){return false}}var J=H;var F=J.clientX;var M=J.clientY;B.beginPoint.x=F;B.beginPoint.y=M;var L=F-B.panelInfo.absoluteLeft;var K=M-B.panelInfo.absoluteTop;var I=$(document).scrollTop();if(I>0){K=K+I}var G=$(document).scrollLeft();if(G>0){L=L+G}B.point1.x=F;B.point1.y=M;B.isInCut=E.isPointInCutter(L,K)});$(document).mouseup(function(){if(v.hasImage==false){return}B.isInDrag=false});$(document).mousemove(function(H){if(v.hasImage==false){return}if(B.isInDrag==false){return}var I=H?H:window.event;var G=I.clientX,F=I.clientY;B.point2.x=G;B.point2.y=F;var K=B.point2.x-B.point1.x;var J=B.point2.y-B.point1.y;B.point1.x=G;B.point1.y=F;if(B.isInCut==true){E.MoveCutterByDelta(K,J)}else{E.MoveBackgroundByDelta(K,J)}})},_init_mobile_operations:function(){var E=this;c.addEventListener("touchstart",function(F){if(v.hasImage==false){return}if(v.movementInterval!=null){clearInterval(v.movementInterval)}if(v.handlingMovement==true){return}var J=F.changedTouches[0].pageX;var H=F.changedTouches[0].pageY;B.isInDrag=true;B.panelInfo=y.GetAbsoluteLocationEx(c);if(B.panelInfo.absoluteLeft==0&&B.panelInfo.absoluteTop==0&&B.panelInfo.offsetHeight==0&&B.panelInfo.offsetWidth==0){}var O=F;var K=J;var I=H;B.beginPoint.x=K;B.beginPoint.y=I;var N=K-B.panelInfo.absoluteLeft;var M=I-B.panelInfo.absoluteTop;var G=$(document).scrollTop();if(G>0){}var L=$(document).scrollLeft();if(L>0){}B.point1.x=K;B.point1.y=I;B.isInCut=E.isPointInCutter(N,M);F.preventDefault();F.stopPropagation()},false);c.addEventListener("touchmove",function(I){if(v.hasImage==false){return}if(B.isInDrag==false){return}if(v.handlingMovement==true){return}v.handlingMovement=true;I.preventDefault();I.stopPropagation();var J=I?I:window.event;var F=I.changedTouches[0].pageX;var M=I.changedTouches[0].pageY;var H=F,G=M;B.point2.x=H;B.point2.y=G;var L=B.point2.x-B.point1.x;var K=B.point2.y-B.point1.y;B.point1.x=H;B.point1.y=G;if(B.isInCut==true){E.MoveCutterByDelta(L,K)}else{E.MoveBackgroundByDelta(L,K)}setTimeout(function(){v.handlingMovement=false},v.timeSepOnHandling)},false);c.addEventListener("touchend",function(F){if(v.hasImage==false){return}v.handlingMovement=false;v.movementInterval=null;B.isInDrag=false;F.preventDefault();F.stopPropagation()},false)},isPointInCutter:function(H,G){var F=g.location.x;var E=g.location.y;var J=F+g.size.w;var I=E+g.size.h;if(H<F||H>J||G<E||G>I){return false}else{return true}},_cut_by_sizing:function(H){var G=document.createElement("canvas");var E=G.getContext("2d");G.width=g.size.w;G.height=g.size.h;var F=new Image();F.onload=function(){E.drawImage(F,g.location.x,g.location.y,g.size.w,g.size.h,0,0,g.size.w,g.size.h);if(H){var I=G.toDataURL("image/jpeg");H(I)}};F.src=s.toDataURL("image/jpeg")},_caculateSizeInfo:function(){var Q=g.location.x-d.location.x;var N=g.location.y-d.location.y;Q=Math.round(Q);N=Math.round(N);Q=Q/d.zoom;N=N/d.zoom;Q=Math.round(Q);N=Math.round(N);var M=g.size.w/d.zoom;var I=g.size.h/d.zoom;var G=Math.round(M);var P=Math.round(I);var K=0;var H=0;var L=0;var O=0;function E(T,U){var S={w:T,h:U,ratio:T/U};return S}var F=G/P;L=F;E(G-1,P);E(G-2,P);E(G+1,P);E(G+2,P);E(G,P-1);E(G,P-2);E(G,P+1);E(G,P+2);var J=0;var R=0;F=(G+J)/(P+R);O=Math.abs(g.ratio-F);K=(G+J);H=(P+R);var J=-1;var R=0;F=(G+J)/(P+R);if(Math.abs(g.ratio-F)<=O){O=Math.abs(g.ratio-F);K=(G+J);H=(P+R)}var J=1;var R=0;F=(G+J)/(P+R);if(Math.abs(g.ratio-F)<=O){O=Math.abs(g.ratio-F);K=(G+J);H=(P+R)}var J=0;var R=-1;F=(G+J)/(P+R);if(Math.abs(g.ratio-F)<=O){O=Math.abs(g.ratio-F);K=(G+J);H=(P+R)}var J=0;var R=1;F=(G+J)/(P+R);if(Math.abs(g.ratio-F)<=O){O=Math.abs(g.ratio-F);K=(G+J);H=(P+R)}G=K;P=H;return{x:Q,y:N,w:G,h:P}},_cut_by_ratio:function(N){var H=this;var J=H._caculateSizeInfo();var K=document.createElement("canvas");var F=K.getContext("2d");K.width=J.w;K.height=J.h;var M=null;var I;if(d.angle==0||d.angle==360){I=x;M=i}else{if(d.angle==90){I=h;M=a}else{if(d.angle==180){I=C;M=l}else{if(d.angle==270){I=e;M=q}}}}f("当前角度："+d.angle+" 当前图片尺寸： "+I.width+" x "+I.height);var L={get_x:J.x,get_y:J.y,get_w:J.w,get_h:J.h,put_x:0,put_y:0};if(L.get_x<0){L.get_w=L.get_w+L.get_x;L.put_x=Math.abs(L.get_x);L.get_x=0}if(L.get_w+L.get_x>I.width){L.get_w=(I.width-L.get_x)}if(L.get_w<0){L.get_w=1}if(L.get_y<0){L.get_h=L.get_h+L.get_y;L.put_y=Math.abs(L.get_y);L.get_y=0}if(L.get_y+L.get_h>I.height){L.get_h=(I.height-L.get_y)}if(L.get_h<0){L.get_h=1}f("裁剪信息如下：");f(JSON.stringify(L));var G=M.getImageData(L.get_x,L.get_y,L.get_w,L.get_h);if(L.put_x<=K.width&&L.put_y<K.height){F.putImageData(G,L.put_x,L.put_y)}else{f("没有执行。")}var E=K.toDataURL("image/jpeg");N(E)},cut:function(F){var E=this;if(A.saveMode=="ratio"){E._cut_by_ratio(F)}else{E._cut_by_sizing(F)}}};k.init();this.init=function(E,F){k.init_background(E,F);k.updateCutter()};this.MoveCutter=function(F,E){k.MoveCutter(F,E)};this.MoveImage=function(F,E){k.MoveBackground(F,E)};this.ScaleImage=function(E){k.ScaleBackground(E)};this.RotateImage=function(E){k.RotateImage(E)};this.hasImage=function(){return v.hasImage};this.show_data_cutter=function(){console.log(g)};this.getImageAngle=function(){return d.angle};this.getImageRotation=function(){return d.angle};this.getImageZoom=function(){return d.zoom};this.cutImg=function(E){k.cut(E)};this.getMinimizeScale=function(){var E=v.minScale;return E};this.getCutInfo=function(){return k._caculateSizeInfo()};this.getImageOriginSize=function(){return{w:d.originSize.w,h:d.originSize.h}}};

(function(){function detectSubsampling(img){var iw=img.naturalWidth,ih=img.naturalHeight;if(iw*ih>1024*1024){var canvas=document.createElement('canvas');canvas.width=canvas.height=1;var ctx=canvas.getContext('2d');ctx.drawImage(img,-iw+1,0);return ctx.getImageData(0,0,1,1).data[3]===0}else{return false}}function detectVerticalSquash(img,iw,ih){var canvas=document.createElement('canvas');canvas.width=1;canvas.height=ih;var ctx=canvas.getContext('2d');ctx.drawImage(img,0,0);var data=ctx.getImageData(0,0,1,ih).data;var sy=0;var ey=ih;var py=ih;while(py>sy){var alpha=data[(py-1)*4+3];if(alpha===0){ey=py}else{sy=py}py=(ey+sy)>>1}var ratio=(py/ih);return(ratio===0)?1:ratio}function renderImageToDataURL(img,options,doSquash){var canvas=document.createElement('canvas');renderImageToCanvas(img,canvas,options,doSquash);return canvas.toDataURL("image/jpeg",options.quality||0.8)}function renderImageToCanvas(img,canvas,options,doSquash){var iw=img.naturalWidth,ih=img.naturalHeight;if(!(iw+ih))return;var width=options.width,height=options.height;var ctx=canvas.getContext('2d');ctx.save();transformCoordinate(canvas,ctx,width,height,options.orientation);var subsampled=detectSubsampling(img);if(subsampled){iw/=2;ih/=2}var d=1024;var tmpCanvas=document.createElement('canvas');tmpCanvas.width=tmpCanvas.height=d;var tmpCtx=tmpCanvas.getContext('2d');var vertSquashRatio=doSquash?detectVerticalSquash(img,iw,ih):1;var dw=Math.ceil(d*width/iw);var dh=Math.ceil(d*height/ih/vertSquashRatio);var sy=0;var dy=0;while(sy<ih){var sx=0;var dx=0;while(sx<iw){tmpCtx.clearRect(0,0,d,d);tmpCtx.drawImage(img,-sx,-sy);ctx.drawImage(tmpCanvas,0,0,d,d,dx,dy,dw,dh);sx+=d;dx+=dw}sy+=d;dy+=dh}ctx.restore();tmpCanvas=tmpCtx=null}function transformCoordinate(canvas,ctx,width,height,orientation){switch(orientation){case 5:case 6:case 7:case 8:canvas.width=height;canvas.height=width;break;default:canvas.width=width;canvas.height=height}switch(orientation){case 2:ctx.translate(width,0);ctx.scale(-1,1);break;case 3:ctx.translate(width,height);ctx.rotate(Math.PI);break;case 4:ctx.translate(0,height);ctx.scale(1,-1);break;case 5:ctx.rotate(0.5*Math.PI);ctx.scale(1,-1);break;case 6:ctx.rotate(0.5*Math.PI);ctx.translate(0,-height);break;case 7:ctx.rotate(0.5*Math.PI);ctx.translate(width,-height);ctx.scale(-1,1);break;case 8:ctx.rotate(-0.5*Math.PI);ctx.translate(-width,0);break;default:break}}var URL=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null;function MegaPixImage(srcImage){if(window.Blob&&srcImage instanceof Blob){if(!URL){throw Error("No createObjectURL function found to create blob url");}var img=new Image();img.src=URL.createObjectURL(srcImage);this.blob=srcImage;srcImage=img}if(!srcImage.naturalWidth&&!srcImage.naturalHeight){var _this=this;srcImage.onload=srcImage.onerror=function(){var listeners=_this.imageLoadListeners;if(listeners){_this.imageLoadListeners=null;for(var i=0,len=listeners.length;i<len;i++){listeners[i]()}}};this.imageLoadListeners=[]}this.srcImage=srcImage}MegaPixImage.prototype.render=function(target,options,callback){if(this.imageLoadListeners){var _this=this;this.imageLoadListeners.push(function(){_this.render(target,options,callback)});return}options=options||{};var imgWidth=this.srcImage.naturalWidth,imgHeight=this.srcImage.naturalHeight,width=options.width,height=options.height,maxWidth=options.maxWidth,maxHeight=options.maxHeight,doSquash=!this.blob||this.blob.type==='image/jpeg';if(width&&!height){height=(imgHeight*width/imgWidth)<<0}else if(height&&!width){width=(imgWidth*height/imgHeight)<<0}else{width=imgWidth;height=imgHeight}if(maxWidth&&width>maxWidth){width=maxWidth;height=(imgHeight*width/imgWidth)<<0}if(maxHeight&&height>maxHeight){height=maxHeight;width=(imgWidth*height/imgHeight)<<0}var opt={width:width,height:height};for(var k in options)opt[k]=options[k];var tagName=target.tagName.toLowerCase();if(tagName==='img'){target.src=renderImageToDataURL(this.srcImage,opt,doSquash)}else if(tagName==='canvas'){renderImageToCanvas(this.srcImage,target,opt,doSquash)}if(typeof this.onrender==='function'){this.onrender(target)}if(callback){callback()}if(this.blob){this.blob=null;URL.revokeObjectURL(this.srcImage.src)}};if(typeof define==='function'&&define.amd){define([],function(){return MegaPixImage})}else if(typeof exports==='object'){module.exports=MegaPixImage}else{this.MegaPixImage=MegaPixImage}})();

var ImageEditorHandler=function(r){var k={cutWidth:150,cutHeight:200,containerWidth:800,containerHeight:600,imageShowWidth:400,imageShowHeight:500,imageEditorElement:"",onSave:function(y){},onBtnResetClick:function(){}};$.extend(k,r);var x=$(k.imageEditorElement);var c=new EJS({url:k.tpl});x.empty().append(c.render({data:{}}));var g=x.find("[ui='preview_img']");var h=x.find("[ui='previewer']");var b=x.find("[ui='cut-area']");var i=x.find("[ui='bar_tool']");var u=x.find("[ui='btn_save']");var w=x.find("[ui='btn_reset']");var t="";var d=x.find("[ui='loading_tips']");var f=x.find("[ui='btn_zoom_out']");var p=x.find("[ui='btn_zoom_in']");var v=x.find("[ui='btn_turn_left']");var a=x.find("[ui='btn_turn_right']");var m=x.find("[ui='btn_cut']");var o=x.find("[ui='btn_zoom_much_in']");var e=x.find("[ui='btn_zoom_much_out']");var q=x.find("[ui='bar_confirm']");var s=x.find("[ui='btn_cancel']");var l={};k.containerElement=b;l=new ImgCut(k);var n={hideAll:function(y){x.hide()},showImageEditor:function(){x.show();h.hide();q.hide();i.show();b.show()},showPreview:function(){x.show();i.hide();b.hide();q.show();h.show()}};f.click(function(){if(l.hasImage()==false){alert("请先选择图片！");return}var A=l.getImageZoom();if(A<0.5){}var y=l.getMinimizeScale();var z=A*0.9;z=parseInt(z*10000)/10000;if(z<y){z=y}l.ScaleImage(z)});e.click(function(){if(l.hasImage()==false){alert("请先选择图片！");return}var A=l.getImageZoom();if(A<0.5){}var y=l.getMinimizeScale();var z=A*0.4;z=parseInt(z*10000)/10000;if(z<y){z=y}l.ScaleImage(z)});p.click(function(){if(l.hasImage()==false){alert("请先选择图片！");return}var z=l.getImageZoom();var y=z*1.1;y=parseInt(y*10000)/10000;if(y>3){y=3}l.ScaleImage(y)});o.click(function(){if(l.hasImage()==false){alert("请先选择图片！");return}var z=l.getImageZoom();var y=z*1.4;y=parseInt(y*10000)/10000;if(y>3){y=3}l.ScaleImage(y)});v.click(function(){if(l.hasImage()==false){alert("请先选择图片！");return}var y=l.getImageAngle();y=(y+360)-90;y=(y)%360;l.RotateImage(y)});a.click(function(){if(l.hasImage()==false){alert("请先选择图片！");return}var y=l.getImageAngle();y=(y+0)+90;y=(y)%360;l.RotateImage(y)});m.click(function(){if(l.hasImage()==false){alert("请先选择图片！");return}l.cutImg(function(y){g.attr("src",y);t=y;n.showPreview();k.onSave(t)})});s.click(function(){n.showImageEditor()});u.click(function(){var y=t;k.onSave(t)});w.click(function(){if(k.onBtnResetClick){k.onBtnResetClick()}});var j={init:function(y,z){l.init(y,z);n.showImageEditor()},hideEditor:function(){n.hideAll()}};return j};